

# Сервис управления ПВЗ и приёмкой товаров

Сервис предоставляет API для управления пунктами выдачи заказов (ПВЗ), обработки приёмок товаров и работы с товарами.
Реализована система аутентификации с разграничением прав между сотрудниками и модераторами.

## Возможности

- Регистрация и аутентификация пользователей (сотрудник/модератор)
- Управление ПВЗ (создание, просмотр с фильтрацией)
- Работа с приёмками товаров:
    - Создание и закрытие приёмок
    - Добавление товаров (электроника, одежда, обувь)
    - Удаление последнего добавленного товара (LIFO)
- Пагинация и фильтрация списка ПВЗ по дате
- JWT-авторизация
- Мониторинг метрик через Prometheus
- gRPC API для интеграций
- Детальное логирование операций

## Технологии

- Go 1.24+
- PostgreSQL
- JWT для аутентификации
- gRPC для межсервисного взаимодействия
- Prometheus + Grafana для мониторинга
- Zap для структурированного логирования
- Docker

## Требования
- Go 1.24 или новее
- PostgreSQL 12+
- Установленные переменные окружения (см. Настройка)

## Установка

1. Клонировать репозиторий:
```bash
git clone https://github.com/the-time-dev/Pickup-Point-Management-System.git
cd Pickup-Point-Management-System
```

2. Установить зависимости:
```bash
go mod download
```

3. Настройка окружения:
   Создайте файл `.env` в корне проекта:
```env
PG_CONN=postgres://user:password@host:port/db_name
JWT_SECRET_KEY=your_secure_secret
PORT=8080
METRICS_PORT=9000
GRPC_PORT=3000
```

4. Запуск:
```bash
go run ./cmd/main.go
```

## Docker-сборка

```bash
docker build -t pvz-service .
~/Pickup-Point-Management-System$ docker run -p 8080:8080 -p 3000:3000 -p 9000:9000   \
-e PG_CONN=postgresql://postgres:18346@172.18.160.1:5432/testing   \
-e JWT_SECRET_KEY=your_secret  \
-e METRICS_PORT=9000 \
-e GRPC_PORT=3000  \
pvz-service
```

## API Документация

### Основные HTTP-эндпоинты

| Метод | Путь                              | Описание                  | Роль           |
| ----- | --------------------------------- | ------------------------- | -------------- |
| POST  | /register                         | Регистрация пользователя  | Любая          |
| POST  | /login                            | Авторизация               | Любая          |
| POST  | /pvz                              | Создание ПВЗ              | Модератор      |
| GET   | /pvz                              | Список ПВЗ с фильтрацией  | Авторизованный |
| POST  | /pvz/{pvzId}/close_last_reception | Закрыть последнюю приёмку | Сотрудник      |
| POST  | /pvz/{pvzId}/delete_last_product  | Удалить последний товар   | Сотрудник      |
| POST  | /receptions                       | Создать приёмку           | Сотрудник      |
| POST  | /products                         | Добавить товар            | Сотрудник      |
| POST  | /dummyLogin                       | Получить тестовый токен   | Любая          |

### gRPC API

Сервер gRPC доступен на порту 3000:

```protobuf
service PVZService {
  rpc GetPVZList(GetPVZListRequest) returns (GetPVZListResponse);
}
```

### Мониторинг метрик

Prometheus метрики доступны на порту 9000 по пути `/metrics`:
```bash
curl http://localhost:9000/metrics
```

Собираемые метрики:
* Технические:
    * Количество запросов
    * Время ответа
* Бизнесовые:
    * Количество созданных ПВЗ
    * Количество созданных приёмок заказов
    * Количество добавленных товаров

## Примеры запросов

**Регистрация пользователя:**
```bash
curl -X POST http://localhost:8080/register \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com", "password":"qwerty", "role":"employee"}'
```

**Получение метрик Prometheus:**
```bash
curl http://localhost:9000/metrics
```

## Логирование

Система использует структурированное логирование через библиотеку Zap. Пример формата логов:
```log
2025-04-21T00:51:02.295+0300 INFO http_api/http_handler.go:64 HTTP Request 
{"method": "GET", "path": "/metrics", "client_ip": "127.0.0.1:41498", "status": 200, "duration": "1.498371ms"}
```

Уровни логирования:
- INFO: основные события системы
- WARN: не критичные ошибки
- ERROR: непредвиденное поведение программы

## Ограничения
- Доступные города для ПВЗ: Москва, Санкт-Петербург, Казань
- Типы товаров: электроника, одежда, обувь
- Таймаут подключения к БД: 5 секунд
- Частота сбора метрик: 15 секунд
